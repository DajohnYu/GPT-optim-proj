import requests
import json
from chromadb.utils import embedding_functions
import sys
import os
from dotenv import load_dotenv

EMBED_MODEL = "all-MiniLM-L6-v2"
embedding_func = embedding_functions.SentenceTransformerEmbeddingFunction(model_name=EMBED_MODEL)

def read_job_description(job):
    with open("./data/jobdescriptions/" + job + ".txt") as file:
        return file.read()

job_description = read_job_description(sys.argv[1])

vector = embedding_func(input=[job_description])[0]

# print(json.dumps(vector, indent=4))

load_dotenv()
ZILLIZ_ENDPOINT = os.getenv('ZILLIZ_ENDPOINT')
ZILLIZ_USER = os.getenv('ZILLIZ_USER')
ZILLIZ_PASSWORD = os.getenv('ZILLIZ_PASSWORD')
COLLECTION_NAME = 'noc_data_cosine_all_MiniLM_L6_v2_with_384_dimensions'

# client = MilvusClient(uri=ZILLIZ_ENDPOINT, token=ZILLIZ_USER+':'+ZILLIZ_PASSWORD)

url = ZILLIZ_ENDPOINT + '/v1/vector/search'

# payload = "{\"collectionName\":\"noc_data_cosine_all_MiniLM_L6_v2_with_384_dimensions\",\"vector\":[0.8047952440898644,0.934006126997791,0.9404922265178128,0.3480291109614084,0.2828935832025574,0.7306958199763809,0.5664201494048441,0.6548111463976458,0.4402886388014565,0.7601740389530434,0.9931007461528435,0.22431837540910793,0.4268767216187811,0.06646787988284142,0.27987928333782575,0.4201944413242218,0.6807174205301709,0.14817680732362315,0.06190257249764919,0.7786192186110686,0.24850533621459603,0.05282321096969356,0.9404448413533952,0.10449284760964883,0.2857034622068231,0.6873978921644811,0.9258113568065297,0.650447136204021,0.03882333554050321,0.4113448859581227,0.5724556161009026,0.16138782796028395,0.7914175890510321,0.8597046154151031,0.10929854966851704,0.1951470560441455,0.39266939139935053,0.10954290215748663,0.31529884301785005,0.6038072418149913,0.6815408053680789,0.3183395284060072,0.21289479416965884,0.3865894135345044,0.14338023975991387,0.795660344165203,0.5267147868182607,0.9366510210809124,0.5296239696341158,0.8511003538856182,0.19403983126395252,0.6136083575780872,0.2539776504441369,0.651766785326875,0.6334223107126037,0.9207929339622144,0.6081969309361135,0.15865265124788086,0.22357215222114668,0.4870441367385503,0.4042289871239486,0.3932287320920793,0.5123015317229864,0.43138677123308544,0.395700421584784,0.49261574114907136,0.8214915862193231,0.9802919903674349,0.3107930330143396,0.47241694578048843,0.2994431925449491,0.6517268211524396,0.5332909628845033,0.058050569307142474,0.6879825050919554,0.13622615974077645,0.1177492117627259,0.3864721840814026,0.24373762348711459,0.6974576118005035,0.8331517895398818,0.6225189760991394,0.7725383083566494,0.9791954987770587,0.23297357696556786,0.4412666359287405,0.3146544417517758,0.5408701799441594,0.3649863057353233,0.903818135682589,0.11189198172293724,0.374357692408788,0.30142694114663615,0.8714857315469068,0.07838207505083417,0.38939943454143755,0.808416953344495,0.6909630567218145,0.8091786225730891,0.023747139227698222,0.9814017075776091,0.5208956853501733,0.30496507210671386,0.4585037616735591,0.7229605935599597,0.9338072163329171,0.17368911598512005,0.9348830051813708,0.7319142566239515,0.8578016920882694,0.9283639124808386,0.2078770166124474,0.9619740154731472,0.9639582955731933,0.08546091388722155,0.8240067830670434,0.7678830470180473,0.8457745733382451,0.955999019534934,0.39586812775547764,0.46654105008153646,0.6759551113656365,0.19953656826936872,0.9808033273613451,0.715232957303976,0.5342434559423107,0.7300290975907888,0.2518750819361195,0.5900071635605052,0.8933473530936685,0.734783808554579,0.5921600977898787,0.5319751205457789,0.3800121064623666,0.5951051725993043,0.5543786568607162,0.07892085574773611,0.25565472951798673,0.5484095280676559,0.11363074276570806,0.9887838014272845,0.12694244046366254,0.9333330264055361,0.18804134067461076,0.12016973427599575,0.1517853092585889,0.7659709766063244,0.6933629419367503,0.1999175448589432,0.6092704339552385,0.31804516162967833,0.7584133266539421,0.7540533859677027,0.8925744769959163,0.9050942307213072,0.37154485570875206,0.5045316995295955,0.2845132601611231,0.8696458485799893,0.12214932483441476,0.3819807043126986,0.18486263537603054,0.15345341957542136,0.1544786679963689,0.601393836543513,0.4422872418772602,0.690255651920655,0.44706848720871983,0.7084715157256054,0.41351488484293686,0.7747044101440665,0.6323352564921779,0.7337084949168864,0.5005679599742379,0.8054353685476311,0.2838178986339941,0.83781687679332,0.4569794740945592,0.5471135719631393,0.39397599380361736,0.318784481152389,0.13395849321659137,0.0155788379256524,0.6017901297083387,0.8616144812988318,0.762471047970752,0.7720978408408555,0.744266378613284,0.8603544463745479,0.012995655955067686,0.959765265098986,0.554930874756433,0.8888458113176972,0.004149066162303927,0.044646458079795615,0.18403574253500676,0.252838501842398,0.8648222652990857,0.815446161349147,0.8580854504255294,0.3473617579560119,0.9625446557752491,0.9884804339969154,0.2003823762262419,0.0905350161099846,0.8190959298775471,0.4624692616922125,0.07351369665668472,0.9027504797380974,0.22098535806597475,0.9885305922003063,0.24095563642185636,0.13037484858262105,0.26279149555721815,0.6352836956083017,0.28608076717599895,0.268901924604652,0.14924244531698727,0.5845164633514367,0.806142021374997,0.737091558106893,0.020559198718773875,0.07350718857224059,0.1150267471846188,0.03905286737962976,0.4954202635894539,0.2773985581264852,0.41441713559331317,0.9287165217178823,0.4192187385635273,0.21900947049938058,0.7138850177515544,0.337703700645425,0.21293211301105797,0.8452489234051012,0.6606518282091953,0.7192578039082471,0.27160373969195895,0.3124416338865915,0.3687968730003951,0.4139010108353237,0.39104536800988476,0.2918119303472364,0.20470993943616778,0.804316234663317,0.7874061479617442,0.5747899435329535,0.27726254861475486,0.22553039667046715,0.753082110139468,0.4392988129774543,0.31493576424236724,0.3370266861981851,0.6884140164613501,0.10563537048016025,0.7460242373935363,0.41325968023907245,0.5647094455183155,0.8012131903161254,0.6569124766846107,0.2377494889694436,0.8521778212696582,0.34799375238563146,0.6860476723262926,0.5524886854647365,0.8527165135965415,0.30545059234380334,0.2752525837593951,0.625323734975616,0.07585484463559322,0.6374454476321757,0.03615110802785326,0.39137077348795457,0.6465719612142056,0.252880180953591,0.396491911287306,0.7157375436990941,0.7903994023029436,0.885303206649854,0.8307723693031637,0.6312138325382136,0.04224044415335704,0.9984789065432246,0.4394447323458788,0.3017351048690766,0.3872047551508375,0.5885209435308104,0.9850866791038374,0.8863980062232639,0.908536702522118,0.30736032076495845,0.13940917188740654,0.08820998647577627,0.8185829168959073,0.7278993730954335,0.1339439569205525,0.8891896107572294,0.6207361452590374,0.646834689418296,0.030851053812550044,0.046406446741628304,0.8669249273154864,0.3209705324100408,0.08648406808056497,0.9241995251207035,0.7998235659718119,0.406130016754952,0.48899494178945047,0.5757869062112456,0.9038454491413862,0.7332403405798292,0.19955937330507412,0.6716241493145702,0.31458892189109955,0.5956772053548961,0.15785708639192286,0.7407775685547336,0.8504006087681105,0.7472648216038227,0.055197527428015425,0.7134954296190488,0.026864017936507723,0.8425868744518038,0.6649752296932959,0.83116959231939,0.6964270872068272,0.7303799891659937,0.7175778912658576,0.53242640828309,0.18177929333081633,0.9834896876456917,0.5968496127456923,0.21472136833006084,0.058245746744768456,0.4817994485198984,0.6816014398930205,0.9888644673058462,0.03961326421037825,0.6746895190087107,0.28133103912313273,0.7630856865796033,0.6737015786635939,0.17644960402514764,0.015259162261539339,0.26480193637550375,0.6217778196964635,0.46914641745839936,0.45127323133851593,0.6188189002584444,0.9381808426990177,0.39517656230297593,0.7753919924139819,0.6624963875277835,0.36254515090417305,0.17309533767844731,0.7042151209614658,0.1432307924479289,0.8337673366961043,0.539628165882725,0.9771792038124916,0.2821622949186835,0.5724139927716737,0.38704547067236494,0.4393609947442254,0.3247374694107178,0.6046363221056553,0.6380526999400183,0.18926761591342156,0.5722410201544913,0.6674509587702674,0.7069225468776796,0.9975665092313282,0.41743547311905926,0.8529863180872931,0.012227523049026856,0.2790554896775863,0.4237391833160864,0.1826291655728559,0.12058239313889019,0.47276366811953596,0.055451703376478756,0.547894418579943,0.98180932493072,0.9362486149142768]}"
data = json.dumps({
    'collectionName': COLLECTION_NAME,
    'vector': vector,
})

headers = {
    "Authorization": "Bearer XXX",
    # "Authorization": "Bearer " + ZILLIZ_USER + ":" + ZILLIZ_PASSWORD,
    "Accept": "application/json",
    "Content-Type": "application/json"
}

response = requests.post(url, data=data, headers=headers)

print(response.json())
